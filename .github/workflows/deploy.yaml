name: Deploy to EC2 K8s

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. 파일 복사 (ubuntu 권한)
      - name: Copy manifest files to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "./apps,./monitoring"
          target: "/home/ubuntu/k8s-manifests"
          strip_components: 1

      # 2. 통합 배포 스크립트 (Secret 갱신 -> Apply -> Rollout Restart)
      - name: Execute deployment commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # ---------------------------------------------------
            # 1. Secret 갱신 (비밀번호 변경 시 즉시 반영을 위해 삭제 후 재생성)
            # ---------------------------------------------------
            echo "Updating Secrets..."
            sudo kubectl delete secret backend-secrets --ignore-not-found
            
            sudo kubectl create secret generic backend-secrets \
              --from-literal=db-password='${{ secrets.REAL_DB_PASSWORD }}' \
              --from-literal=session-secret='${{ secrets.REAL_SESSION_SECRET }}'

            # ---------------------------------------------------
            # 2. 리소스 적용 (Deployment, Service, Ingress 수정사항 반영)
            # ---------------------------------------------------
            echo "Applying Manifests..."
            sudo kubectl apply -f /home/ubuntu/k8s-manifests/apps/backend/
            sudo kubectl apply -f /home/ubuntu/k8s-manifests/apps/frontend/
            sudo kubectl apply -f /home/ubuntu/k8s-manifests/apps/ingress/

            # (옵션) 모니터링
            # sudo kubectl apply -f /home/ubuntu/k8s-manifests/monitoring/grafana/
            # sudo kubectl apply -f /home/ubuntu/k8s-manifests/monitoring/prometheus/

            # ---------------------------------------------------
            # 3. 강제 롤아웃 (중요: 시크릿 변경이나 이미지 갱신 반영을 위해 필수)
            # ---------------------------------------------------
            echo "Restarting Deployments..."
            sudo kubectl rollout restart deployment community-be
            sudo kubectl rollout restart deployment community-fe

            # ---------------------------------------------------
            # 4. 상태 확인
            # ---------------------------------------------------
            echo "Checking Pod Status..."
            sudo kubectl get pods -A